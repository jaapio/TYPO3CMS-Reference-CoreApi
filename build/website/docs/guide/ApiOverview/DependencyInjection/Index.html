<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
                    <title>phpDocumentor</title>
    

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="../../../">
    <link rel="icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/base.css">
            <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@100;200;300;400;600;700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/template.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism-okaidia.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-highlight/prism-line-highlight.css">
                <script src="https://cdn.jsdelivr.net/npm/fuse.js@3.4.6"></script>
        <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
        <script src="js/template.js"></script>
        <script src="js/search.js"></script>
        <script defer src="js/searchIndex.js"></script>
    </head>
<body id="top">
    <header class="phpdocumentor-header phpdocumentor-section">
    <h1 class="phpdocumentor-title"><a href="" class="phpdocumentor-title__link">phpDocumentor</a></h1>
    <input class="phpdocumentor-header__menu-button" type="checkbox" id="menu-button" name="menu-button" />
    <label class="phpdocumentor-header__menu-icon" for="menu-button">
        <i class="fas fa-bars"></i>
    </label>
    <section data-search-form class="phpdocumentor-search">
    <label>
        <span class="visually-hidden">Search for</span>
        <svg class="phpdocumentor-search__icon" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="7.5" cy="7.5" r="6.5" stroke="currentColor" stroke-width="2"/>
            <line x1="12.4892" y1="12.2727" x2="19.1559" y2="18.9393" stroke="currentColor" stroke-width="3"/>
        </svg>
        <input type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading .." disabled />
    </label>
</section>

    <nav class="phpdocumentor-topnav">
    <ul class="phpdocumentor-topnav__menu">
        </ul>
</nav>
</header>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <input class="phpdocumentor-sidebar__menu-button" type="checkbox" id="sidebar-button" name="sidebar-button" />
<label class="phpdocumentor-sidebar__menu-icon" for="sidebar-button">
    Menu
</label>
<aside class="phpdocumentor-column -three phpdocumentor-sidebar">
                    <section class="phpdocumentor-sidebar__category">
            <h2 class="phpdocumentor-sidebar__category-header">typo3-explained</h2>
                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/Introduction/Index.html#introduction" class="">Introduction</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/Introduction/Index.html#system-overview-1" class="">System Overview</a>
                
            </li>
                    <li>
                <a href="guide/Introduction/Index.html#a-basic-installation" class="">A basic installation</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/ApiOverview/Index.html#api-a-z" class="">API A-Z</a>
</h4>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/CodingGuidelines/Index.html#cgl" class="">Coding Guidelines</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/CodingGuidelines/Introduction.html#cgl-introduction" class="">Introduction</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglPhp/Index.html#cgl-php" class="">PHP Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglJavaScript/Index.html#cgl-javascript" class="">JavaScript Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglTypeScript/Index.html#cgl-typescript" class="">TypeScript Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglTypoScript/Index.html#cgl-typoscript" class="">TypoScript Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglTsConfig.html#cgl-tsconfig" class="">TSconfig Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglXliff/Index.html#cgl-xliff" class="">Xliff Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglYaml.html#cgl-yaml" class="">Yaml Coding Guidelines</a>
                
            </li>
                    <li>
                <a href="guide/CodingGuidelines/CglRest/Index.html#cgl-rest" class="">reStructuredText (reST)</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/Configuration/Index.html#configuration" class="">Configuration</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/Configuration/ConfigurationOverview.html#config-overview" class="">Configuration overview</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/Glossary.html#configuration-classification" class="">Glossary</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/ConfigurationFiles.html#configuration-files" class="">Configuration files</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/ConfigurationModule/Index.html#configuration-module" class="">Configuration module</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/FeatureToggles.html#feature-toggles" class="">Feature toggles</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/GlobalVariables.html#globals-variables" class="">$GLOBALS</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/Typo3ConfVars/Index.html#typo3-conf-vars" class="">TYPO3_CONF_VARS</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/Typo3Information.html#typo3Information" class="">Global meta information about TYPO3</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/Tsconfig.html#tsconfig" class="">TSconfig</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/TypoScriptSyntax/Index.html#typoscript-syntax-about" class="">TypoScript syntax</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/UserSettingsConfiguration/Index.html#user-settings" class="">User settings configuration</a>
                
            </li>
                    <li>
                <a href="guide/Configuration/Yaml/Index.html#yaml" class="">YAML</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/ExtensionArchitecture/Index.html#extension-development" class="">Extension development</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/ExtensionArchitecture/Concepts/Index.html#extension-concepts" class="">Concepts</a>
                
            </li>
                    <li>
                <a href="guide/ExtensionArchitecture/FileStructure/Index.html#extension-reserved-folders-legacy" class="">File structure</a>
                
            </li>
                    <li>
                <a href="guide/ExtensionArchitecture/HowTo/Index.html#extension-howto" class="">Howto</a>
                
            </li>
                    <li>
                <a href="guide/ExtensionArchitecture/Extbase/Index.html#extbase" class="">Extbase</a>
                
            </li>
                    <li>
                <a href="guide/ExtensionArchitecture/BestPractises/Index.html#extension-Best-practises" class="">Best practises and conventions</a>
                
            </li>
                    <li>
                <a href="guide/ExtensionArchitecture/Tutorials/Index.html#extension-tutorials" class="">Tutorials</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/Security/Index.html#security" class="">Security guidelines</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/Security/Introduction/Index.html#security-introduction" class="">Introduction</a>
                
            </li>
                    <li>
                <a href="guide/Security/SecurityTeam/Index.html#security-team" class="">The TYPO3 Security Team</a>
                
            </li>
                    <li>
                <a href="guide/Security/GeneralInformation/Index.html#security-general-information" class="">General Information</a>
                
            </li>
                    <li>
                <a href="guide/Security/TypesOfThreats/Index.html#security-threats" class="">Types of Security Threats</a>
                
            </li>
                    <li>
                <a href="guide/Security/GeneralGuidelines/Index.html#security-general-guidelines" class="">General guidelines</a>
                
            </li>
                    <li>
                <a href="guide/Security/GuidelinesAdministrators/Index.html#security-administrators" class="">Guidelines for System Administrators</a>
                
            </li>
                    <li>
                <a href="guide/Security/GuidelinesExtensionDevelopment/Index.html#security-extension-development" class="">Guidelines for extension development</a>
                
            </li>
                    <li>
                <a href="guide/Security/GuidelinesIntegrators/Index.html#security-integrators" class="">Guidelines for TYPO3 integrators</a>
                
            </li>
                    <li>
                <a href="guide/Security/GuidelinesEditors/Index.html#security-editors" class="">Guidelines for editors</a>
                
            </li>
                    <li>
                <a href="guide/Security/Backups/Index.html#security-backups" class="">Backup strategy</a>
                
            </li>
                    <li>
                <a href="guide/Security/HackedSite/Index.html#security-detect-analyze-repair" class="">Detect, analyze and repair a hacked site</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/Testing/Index.html#testing" class="">Testing</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/Testing/History.html#testing-history" class="">History</a>
                
            </li>
                    <li>
                <a href="guide/Testing/CoreTesting.html#testing-core" class="">Core testing</a>
                
            </li>
                    <li>
                <a href="guide/Testing/ExtensionTesting.html#testing-extensions" class="">Extension testing</a>
                
            </li>
                    <li>
                <a href="guide/Testing/ProjectTesting.html#testing-projects" class="">Project testing</a>
                
            </li>
                    <li>
                <a href="guide/Testing/WritingUnit.html#testing-writing-unit" class="">Writing unit tests</a>
                
            </li>
                    <li>
                <a href="guide/Testing/WritingFunctional.html#testing-writing-functional" class="">Writing functional tests</a>
                
            </li>
                    <li>
                <a href="guide/Testing/WritingAcceptance.html#testing-writing-acceptance" class="">Writing acceptance tests</a>
                
            </li>
                    <li>
                <a href="guide/Testing/Faq.html#testing-faq" class="">FAQ</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/About.html#about" class="">About This Manual</a>
</h4>
    <ul class="phpdocumentor-list">
                    <li>
                <a href="guide/About.html#intended-audience" class="">Intended Audience</a>
                
            </li>
                    <li>
                <a href="guide/About.html#code-examples-1" class="">Code examples</a>
                
            </li>
                    <li>
                <a href="guide/About.html#feedback-and-contribute" class="">Feedback and Contribute</a>
                
            </li>
                    <li>
                <a href="guide/About.html#credits-1" class="">Credits</a>
                
            </li>
                    <li>
                <a href="guide/About.html#dedication-1" class="">Dedication</a>
                
            </li>
            </ul>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/Sitemap.html#sitemap" class="">Sitemap</a>
</h4>

                                    <h4 class="phpdocumentor-sidebar__root-namespace">
    <a href="guide/genindex.html#index" class="">Index</a>
</h4>

                        </section>
            
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="indices/files.html">Files</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -nine phpdocumentor-content">
                                        <section>
        
<a id="DependencyInjection"></a>
<div class="section" id="Dependency-Injection">
    <h1>Dependency injection</h1>
            <p>:local:</p>
    </div>
<div class="section" id="abstract">
    <h1>Abstract</h1>
            <p>This chapter explains &quot;Dependency Injection (DI)&quot; <em>as used in TYPO3.</em> Readers
interested in the general concepts and principles may want to look at, for
example, <a href="https://phptherightway.com/#dependency_injection">Dependency Injection</a> in &quot;PHP The Right Way&quot; or
<a href="http://fabien.potencier.org/what-is-dependency-injection.html">What is dependency injection?</a> by Fabien
Potencier. Whenever a class has a <em>service dependency</em> to another class the
technique of <em>dependency injection</em> should be used to satisfy that need. TYPO3
uses a Symfony component for dependency injection. The component is <a href="https://www.php-fig.org/psr/psr-11/">PSR-11</a> compliant, and it is used throughout
Core and extensions to standardize object initialization. By default all API
services shipped with the TYPO3 Core system extensions offer dependency
injection. The recommended usage is constructor injection. Available as well are method injection and interface injection.
To activate the Symfony component for dependency injection a few lines of
configuration are necessary.</p>
    </div>
<div class="section" id="introduction">
    <h1>Introduction</h1>
            <p>The title of this chapter is &quot;dependency injection&quot; (DI), but the scope is a bit
broader: In general, this chapter is about <em>TYPO3 object lifecycle management</em> and
<em>how to obtain objects</em>, with one sub-part of it being dependency injection.</p>
            <p>The underlying interfaces are based on the PHP-FIG (PHP Framework Interop Group) standard
<a href="https://www.php-fig.org/psr/psr-11/">PSR-11 Container interface</a>, and the
implementation is based on <a href="https://symfony.com/doc/current/service_container.html">Symfony service container</a>
and <a href="https://symfony.com/doc/current/components/dependency_injection.html">Symfony dependency injection</a> components,
plus some TYPO3 specific sugar.</p>
            <p>This chapter not only talks about Symfony DI and its configuration via Services.yaml,
but also a bit about services in general, about GeneralUtility::makeInstance() and the
SingletonInterface. And since the TYPO3 core already had an object lifecycle management
solution with the extbase ObjectManager before Symfony services were implemented, we&#039;ll
also talk about how to transition away from it towards the core-wide Symfony solution.</p>
    </div>
<div class="section" id="background-and-history">
    <h1>Background and history</h1>
            <p>Obtaining object instances in TYPO3 has always been straightforwardGeneralUtility::makeInstance(\MyVendor\MyExtension\Some\Class::class) and hand over
mandatory and optional :php:`__construct()` arguments as additional arguments.</p>
            <p>There are two quirks to that:</p>
            

<ul>
    <li>First, a class instantiated through makeInstance() can implement SingletonInterface.
This empty interface definition tells makeInstance() to instantiate the object exactly once
for this request, and if another makeInstance() call asks for it, <em>the same object instance</em>
is returned - otherwise makeInstance() always creates a new object instance and returns it.</li>
    <li>Second, makeInstance() allows "XCLASSing". This is a - rather dirty -
way to substitute a class with a custom implementation. XCLASS&#039;ing in general is
brittle and seen as a last resort hack if no better solution is available. In connection
with Symfony containers, XCLASSing services should be avoided in general and service
overrides should be used instead. Replacing the XCLASS functionality in TYPO3 is still work in progress.
In contrast, XCLASSing is still useful for data objects, and there is no good other solution yet.</li>
</ul>
            <p>Using makeInstance() worked very well for a long time. It however lacked a feature
that has been added to the PHP world after makeInstance() had been invented: Dependency injection.
There are lots of articles about dependency injection on the net, so we won&#039;t go too deep
here but rather explain the main idea: The general issue appears when classes follow the
<a href="https://en.wikipedia.org/wiki/Separation_of_concerns">separation of concerns</a>
principle.</p>
            <p>One of the standard examples is logging. Let&#039;s say a class&#039;s responsibility is the
creation of users - it checks everything and finally writes a row to database. Now, since
this is an important operation, the class wants to log an information like &quot;I just created user &#039;foo&#039;&quot;.
And this is where dependency injection enters the game: Logging is a huge topic, there are
various levels of error, information can be written to various destinations and so on. The
little class does not want to deal with all those details, but just wants to tell the framework: &quot;Please
give me some logger I can use and that takes care of all details, I don&#039;t want to know about details&quot;. This
separation is the heart of <em>single responsibility</em> and <em>separation of concerns</em>.</p>
            <p>Dependency injection does two things for us here: First, it allows separating concerns, and second,
it hands the task of finding an appropriate implementation of a dependency over to the framework,
so the framework decides - based on configuration - which specific instance is given to the
consumer. Note in our example, the logging instance itself may have dependencies again - the process
of object creation and preparation may be further nested.</p>
            <p>In more abstract software engineering terms: <a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency injection</a>
is a pattern used to delegate the task of resolving class dependencies away from a consumer
towards the underlying framework.</p>
            <p>Back to historymakeInstance() has been around for quite a while and lacked an
implementation of dependency injection, Extbase appeared in 2009. Extbase brought a first container
and dependency injection solution, it&#039;s main interface being the Extbase ObjectManager.
The Extbase object manager has been widely used for a long time, but suffered from some
issues younger approaches don&#039;t face. One of the main drawbacks of Extbase object manager
is the fact that it&#039;s based on runtime reflection: Whenever an object is to be instantiated,
the object manager scans the class for needed injections and prepares dependencies to be
injected. This process is quite slow though mitigated by various caches. And these also
come with costs. In the end, these issues have been the main reason the object manager
was never established as a main core concept but only lived in Extbase scope.</p>
            <p>The object lifecycle and dependency injection solution based on Symfony DI has been
added in TYPO3v10 and is a general core conceptmakeInstance() as a long living
backwards compatibility solution, and it fully substitutes the Extbase object manager. In
contrast to the Extbase solution, Symfony based object management does <em>not</em> have the
overhead of
expensive runtime calculations. Instead it is an instance wide build-time solution: When
TYPO3 bootstraps, all object creation details of all classes are read from
a single cache file just once, and afterwards no expensive calculation is required
for actual creation.</p>
            <p>Symfony based DI was implemented in TYPO3 v10 and usage of the Extbase
ObjectManager was discouraged. With TYPO3 v11 the core doesn&#039;t use the
ObjectManager any more. It is actively deprecated in v11 and thus leads to
&#039;deprecation&#039; level log entries.</p>
            <p>With TYPO3 v12 the Extbase ObjectManager is actually gone. Making use of
Symfony DI integration still continues. There
are still various places in the core to be improved. Further streamlining will
be done over time. For instance, the final fate of makeInstance()
and the SingletonInterface has not fully been decided on yet. Various
tasks remain to be solved in younger TYPO3 developments to further improve the
<em>object lifecycle management</em> provided by the core.</p>
    </div>
<div class="section" id="build-time-caches">
    <h1>Build-time caches</h1>
            <p>To get a basic understanding of the core&#039;s lifecycle management it is helpful to
get a rough insight on the main construct. As already mentioned, <em>object lifecycle
management</em> is conceptualized as steps to take place at <em>build-time</em>.
It is done very early and only once during the TYPO3
bootstrap process. All calculated
information is written to a special cache that can not be reconfigured and is available
early. On subsequent requests the cache file is loaded.
Extensions can not mess with the construct if they adhere to the core API.</p>
            <p>Besides being created early, the state of the container is independent and
exactly the same in <em>frontend</em>, <em>backend</em> and <em>CLI scope</em>. The same container instance may
even be used for multiple requests. This is becoming more and more important nowadays with the
core being able to execute sub requests. The only exception to this is the
<em>Install Tool</em>: It uses a more basic container that &quot;cannot fail&quot;. This difference
is not important for extension developers however since they can&#039;t hook into the Install Tool
at those places anyways.</p>
            <p>The Symfony container implementation is usually configured to actively scan the
extension classes for needed injections. All it takes are just a couple
of lines within the Services.yaml file. This should be done within all extensions that
contain PHP classes and it is the fundamental setup we will outline in the following sections.</p>
            <p>For developers, it is important to understand that dealing with Symfony DI is
an <em>early core bootstrap</em> thing. The system will fail upon misconfiguration, so
frontend and backend may be unreachable.</p>
            <blockquote><p>Errors in the DI cache may block frontend and backend!</p><p>The DI cache does not heal by itself but needs to be cleared manually!</p></blockquote>
            <p>The container cache entry (at the time of this writing) <em>is not</em> deleted when a
backend admin user clicks &quot;Clear all cache&quot; in the backend top toolbar. The only
way to force a DI recalculation is using the &quot;Admin tools&quot; -&gt; &quot;Maintenance&quot; -&gt; &quot;Flush Caches&quot;
button of the backend embedded Install Tool or the standalone Install Tool (/typo3/install.php) itself. This
meansvar/cache/code/di/* files, which reside in typo3temp/ in Legacy Mode
instances or elsewhere in Composer Mode instances (see Environment). TYPO3 will
then recalculate the cache upon the next access, no matter if it&#039;s a frontend, a backend
or a CLI request.</p>
            <p>The main takeaway isvar/log/typo3_* files contain the exception with backtrace!</p>
    </div>
<div class="section" id="important-terms">
    <h1>Important terms</h1>
            <p>We will continue to use a couple of technical terms in this chapter, so let&#039;s quickly
define them to align. Some of them are not precisely used in our world, for
instance some Java devs may stumble upon &quot;our&quot; understanding of a prototype.</p>
            <dl>
                        <dt>Prototype</dt>
        
        <dd>The broad understanding of a <em>prototype</em> within the TYPO3 community is
that it&#039;s simply an object that is created anew every time. Basically the direct
opposite of a <em>singleton</em>. In fact, the prototype pattern describes a base object that
is created once, so :php:`__construct()` is called to set it up, after that it is
cloned each time one wants to have a new instance of it. The community isn&#039;t well aware
of that, and the core provides no &quot;correct&quot; prototype API, so the word <em>prototype</em> is
often misused for an object that is always created anew when the framework is
asked to create one.</dd>                        <dt>Singleton</dt>
        
        <dd>A <em>singleton</em> is an object that is instantiated
exactly once within one request. If an instance is requested and the object has been
created once already, the same instance is returned. Codewise, this is sometimes done by
implementing a static getInstance() method that parks the instance in a property.
In TYPO3, this can also be achieved by implementing the SingletonInterface,
where makeInstance() then stores the object internally. Within containers, this can be done
by declaring the object as shared (shared: true), which is the default. We&#039;ll come back to
details later. Singletons <em>must not</em> have state - they must act the same way each time
they&#039;re used, no matter where, how often or when they&#039;ve been used before. Otherwise the behavior of a singleton
object is undefined and will lead to obscure errors.</dd>                        <dt>Service</dt>
        
        <dd>This is another &quot;not by the book&quot; definition. We use the understanding
&quot;What is a service?&quot; from Symfony$container-get() and indirectly via DI)
<em>is a service</em>. These are many things - for instance controllers are services, as well as
- non static - utilities, repositories and obvious classes like mailers and similar. To emphasize*Service suffix are services but basically anything. It
does not matter much if those services are stateless or not. Controllers, for instance,
are usually <em>not</em> stateless. (This is just a configuration detail from this point of view.)
Note: The TYPO3 Core does not strictly follow this behavior in all cases yet, but it strives
to get this more clean over time.</dd>                        <dt>Data object</dt>
        
        <dd><p>Data objects are the opposite of services. They are <em>not</em> available
through service containers. Here calling $container-has() returns false and they can not be
injected. They are instantiated either with new() or GeneralUtility::makeInstance().
Domain models or DTO are a typical example of data objects.</p><p><em>Note:</em><em>Data objects</em> are <em>not</em> &quot;service container aware&quot;
and do not support DI. Although the TYPO3 core does not strictly follow this rule in all cases
until now the ambition is to get this done over time.</p></dd><dd></dd>    </dl>
            <a id="supported-ways-of-dependency-injection"></a>
            <a id="Using-DI"></a>
    </div>
<div class="section" id="using-di">
    <h1>Using DI</h1>
            <p>Now that we have a general understanding of what a service and what a data
object is, let&#039;s turn to usages of services. We will mostly use examples for
this.</p>
            <p><em>The general rule is:</em> Whenever your class has a service dependency to another class,
one of the following solutions should be used.</p>
            <div class="section" id="when-to-use-dependency-injection-in-typo3">
    <h2>When to use Dependency Injection in TYPO3</h2>
            <p>Class dependencies to services should be injected via constructor injection or
setter methods. Where possible, Symfony dependency injection should be used for
all cases where DI is required.
Non-service &quot;data objects&quot; like Extbase domain model instances or DTOs should
be instantiated via \TYPO3\CMS\Core\Utility\GeneralUtility::makeInstance()
if they are non-final and support XCLASSing. For final classes without
dependencies plain instantiation via the new keyword must be used.</p>
            <a id="Constructor-injection"></a>
    </div>
            <div class="section" id="constructor-injection">
    <h2>Constructor injection</h2>
            <p>Assume we&#039;re writing a controller that renders a list of users. Those users are
found using a custom UserRepository, so the repository service is a direct dependency of the
controller service. A typical constructor dependency injection to resolve the
dependency by the framework looks like this:</p>
            <pre><code class="language-php">namespace MyVendor\MyExtension\Controller;

use MyVendor\MyExtension\Repository\UserRepository;

final class UserController
{
     public function __construct(private readonly UserRepository $userRepository)
     {
     }
}</code></pre>
            <p>Here the Symfony container sees a dependency to UserRepository when scanning `__construct()
of the :php:UserController. Since autowiring is enabled by default (more on that below), an instance of the :php:UserRepositoryis created and provided when the controller is created. The example usesconstructor
property promotion &lt;httpsreadonly, so it can not be written a second time.</p>
            <a id="Method-injection"></a>
    </div>
            <div class="section" id="method-injection">
    <h2>Method injection</h2>
            <p>A second way to get services injected is by using inject*() methods:</p>
            <pre><code class="language-php">namespace MyVendor\MyExtension\Controller;

use MyVendor\MyExtension\Repository\UserRepository;

final class UserController
{
     private ?UserRepository $userRepository = null;

     public function injectUserRepository(UserRepository $userRepository)
     {
         $this-&gt;userRepository = $userRepository;
     }
}</code></pre>
            <p>This ends up with the basically the same result as aboveUserRepository in class property $userRepository.
The injection via methods was introduced by Extbase and TYPO3 core implemented it in addition to
the default Symfony constructor injection. Why did we do that, you may ask? Both
strategies have subtle differencesinject*() methods, the type
hinted class property needs to be nullable, otherwise PHP &gt;= 7.4 throws a warning
since the instance is not set during :php:`__construct()`. But that&#039;s just an
implementation detail. More important is an abstraction scenario. Consider this case:</p>
            <pre><code class="language-php">namespace MyVendor\MyExtension\Controller;

use MyVendor\MyExtension\Repository\UserRepository;
use MyVendor\MyExtension\Logger\Logger;

abstract class AbstractController
{
     protected ?Logger $logger = null;

     public function injectLogger(Logger $logger)
     {
         $this-&gt;logger = $logger;
     }
}

final class UserController extends AbstractController
{
     private UserRepository $userRepository;

     public function __construct(UserRepository $userRepository)
     {
         $this-&gt;userRepository = $userRepository;
     }
}</code></pre>
            <p>We have an abstract constroller service with a dependency plus a controller service that extends
the abstract and has further dependencies.</p>
            <p>Now assume the abstract class is provided by TYPO3 core and the consuming class
is provided by an extension. If the abstract class would use constructor injection,
the consuming class would need to know the dependencies of the abstract, add its
own dependency to the constructor, and then call parent::__construct($logger) to
satisfy the dependency of the abstract. This would hardcode all dependencies
of the abstract into extending classes. If later the abstract is changed and
another dependency is added to the constructor, this would break consuming
classes since they did not know that.</p>
            <p><em>Differently put`__construct() with dependencies,
the core can not add dependencies without being breaking. This is the reason why
for example the extbase :php:AbstractControlleruses :php:inject</em>()methods for its dependencies: Extending classes can then use constructor injection, do not need to call :php:parent::__construct()`, and the core is free to change dependencies of
the abstract.</p>
            <p>In general, when the core provides abstract classes that are expected to be
extended by extensions, the abstract class should use inject*() methods instead of
constructor injection. Extensions of course can follow this idea in similar
scenarios.</p>
            <p>This construct has some further implicationsprivate, so extending classes
can not rely on them. Furthermore, classes that should <em>not</em> be extended by extensions
are free to use constructor injection and <em>should</em> be marked final, making
sure they can&#039;t be extended to allow internal changes.</p>
            <p>As a last note on method injection, there is another way to do itsetFooDependency() method if it has the annotation @required.
This second way of method injection however is not used within the TYPO3
framework, should be avoided in general, and is just mentioned here for completeness.</p>
            <a id="interface-injection"></a>
    </div>
            <div class="section" id="interface-injection">
    <h2>Interface injection</h2>
            <p>Apart from constructor injection and inject*() method injection, there is another
useful dependency injection scenario. Look at this example:</p>
            <pre><code class="language-php">namespace MyVendor\MyExtension\Controller;

use MyVendor\MyExtension\Logger\LoggerInterface;

final class UserController extends AbstractController
{
     protected LoggerInterface $logger;

     public function __construct(LoggerInterface $logger)
     {
         $this-&gt;logger = $logger;
     }
}</code></pre>
            <p>See the difference? We&#039;re requesting the injection of an interface and not a class!
It works for both constructor and method injection. It forces the service container
to look up which specific class is configured as implementation of the interface and
inject an instance of it. This is the true heart of dependency injection: A consuming
class no longer codes on a specific implementation, but on the signature of the interface.
The framework makes sure something is injected that satisfies the interface,
the consuming class does not care, it just knows about the interface methods. An
instance administrator can decide to configure the framework to inject some
different implementation than the default, and that&#039;s fully transparent
for consuming classes.</p>
    </div>
    </div>
<div class="section" id="using-container-get">
    <h1>Using container-&gt;get()</h1>
            <p>[WIP] Service containers provide two methods to obtain objects, first via $container-get(),
and via DI. This is only available for services itself$container-get(). DI is
supported in two waysinject*() method injection.
They lead to the same result, but have subtle differences. More on that later.</p>
            <p>In general, services should use DI (constructor or method injection) to obtain dependencies.
This is what you&#039;ll most often find when looking at core implementations. However, it
is also possible to <em>get the container injected</em> and then use $container-get()
to instantiate services. This is useful for factory-like services where the exact name of classes is determined at runtime.</p>
            <a id="configure-dependency-injection-in-extensions"></a>
            <a id="dependency-injection-Configuration"></a>
    </div>
<div class="section" id="configuration">
    <h1>Configuration</h1>
            <div class="section" id="configure-dependency-injection-in-extensions">
    <h2>Configure dependency injection in extensions</h2>
            <p>Extensions have to configure their classes to make use of the
dependency injection. This can be done in Configuration/Services.yaml.
Alternatively, Configuration/Services.php can also be used.
A basic Services.yaml file of an extension looks like the following.</p>
            <div class="phpdocumentor-admonition -note">
            <svg class="phpdocumentor-admonition__icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                    <article>
        <p>Whenever the service configuration or class dependencies change, the Core
cache must be flushed in the Admin Tools  Maintenance or via the CLI
command cache:flush to rebuild the compiled Symfony container. Flushing
all caches from the Clear cache menu does not flush the compiled Symfony
container.</p>

    </article>
</div>
            <pre><code class="language-yaml">services:
  _defaults:
    autowire: true
    autoconfigure: true
    public: false

  MyVendor\MyExtension\:
    resource: &#039;../Classes/*&#039;
    exclude: &#039;../Classes/Domain/Model/*&#039;</code></pre>
            <a id="dependency-injection-autowire"></a>
            <dl>
                        <dt>autowire</dt>
        
        <dd><p>autowire: true instructs the dependency injection component to
calculate the required dependencies from type declarations. This works for
constructor injection and inject*() methods. The calculation
generates a service initialization code which is cached in the TYPO3 Core
cache.</p><dl>
                        <dt>An extension does not have to use autowiring, but can wire</dt>
        
        <dd>dependencies manually in the service configuration file.</dd>    </dl></dd>    </dl>
            <a id="dependency-injection-autoconfigure"></a>
            <dl>
                        <dt>autoconfigure</dt>
        
        <dd>It is suggested to enable autoconfigure: true as this
automatically adds Symfony service tags based on implemented interfaces or
base classes. For example, autoconfiguration ensures that classes
implementing \TYPO3\CMS\Core\SingletonInterface are publicly
available from the Symfony container and marked as shared
(shared: true).</dd>                        <dt>Model exclusion</dt>
        
        <dd>The path exclusion exclude: '../Classes/Domain/Model/*' excludes
your models from the dependency injection container, which means you cannot inject them
nor inject dependencies into them. Models are not services and therefore
should not require dependency injection. Also, these objects are created by
the Extbase persistence layer, which does not support the DI container.</dd><dd></dd>    </dl>
            <a id="DependencyInjectionArguments"></a>
    </div>
            <div class="section" id="arguments">
    <h2>Arguments</h2>
            <p>In case you turned off autowire or need special arguments, you can
configure those as well. This means that you can set autowire: false for
an extension, but provide the required arguments via config specifically for
the desired classes. This can be done in chronological order or by naming.</p>
            <pre><code class="language-yaml">MyVendor\MyExtension\UserFunction\ClassA:
  arguments:
    $argA: &#039;@TYPO3\CMS\Core\Database\ConnectionPool&#039;

MyVendor\MyExtension\UserFunction\ClassB:
  arguments:
    - &#039;@TYPO3\CMS\Core\Database\ConnectionPool&#039;</code></pre>
            <p>This allows you to inject concrete objects like the Connection:</p>
            <pre><code class="language-yaml">connection.pages:
  class: &#039;TYPO3\CMS\Core\Database\Connection&#039;
  factory:
    - &#039;@TYPO3\CMS\Core\Database\ConnectionPool&#039;
    - &#039;getConnectionForTable&#039;
  arguments:
    - &#039;pages&#039;

MyVendor\MyExtension\UserFunction\ClassA:
  public: true
  arguments:
    - &#039;@connection.pages&#039;</code></pre>
            <p>Now you can access the Connection instance within ClassA. This
allows you to execute your queries without further instantiation. For example,
this method of injecting objects also works with extension configurations and
with TypoScript settings.</p>
    </div>
            <div class="section" id="public">
    <h2>Public</h2>
            <p>public: false is a performance optimization and should therefore be set
in extensions. This settings controls which services are available through the
dependency injection container used internally by
GeneralUtility::makeInstance(). However, some classes that need to be
public are automatically marked as public due to autoconfigure: true
being set. These classes include singletons, as they must be shared with code
that uses GeneralUtility::makeInstance() and Extbase controllers.</p>
            <a id="knowing-what-to-make-public"></a>
            <a id="What-to-make-public"></a>
    </div>
            <div class="section" id="what-to-make-public">
    <h2>What to make public</h2>
            <p>Instances of \TYPO3\CMS\Core\SingletonInterface and Extbase controllers
are automatically marked as public. Some further classes must be marked as
public, too. As the Symfony documentation &quot;Public and private services&quot; puts
it:</p>
            <blockquote><p>Simply said: A service can be marked as private if you do not want to access
it directly from your code.</p><p>-- <a href="guide/ApiOverview/DependencyInjection/Index.html#symfony-documentation">Symfony documentation</a></p></blockquote>
            <p>Direct access includes instantiation via GeneralUtility::makeInstance()
with constructor arguments.</p>
            <p>This means every class that is directly retrieved using
GeneralUtility::makeInstance() <em>and</em> requires dependency injection
<strong>must</strong> be marked as public. Any other class which requires dependency injection
and is retrieved by dependency injection itself can be private. Instances of
\TYPO3\CMS\Core\SingletonInterface and Extbase controllers are
automatically marked as public because they are retrieved using
GeneralUtility::makeInstance(). More examples of classes that must be
marked as public:</p>
            

<ul>
    <li>User functions</li>
    <li>Non-Extbase controllers</li>
    <li>Classes registered in hooks</li>
    <li>Authentication services</li>
    <li>Fluid data processors
(only necessary if not tagged as
data.processor).</li>
</ul>
            <p>For such classes, an extension can override the global configuration
public: false in Configuration/Services.yaml for each affected
class:</p>
            <pre><code class="language-yaml">services:
  _defaults:
    autowire: true
    autoconfigure: true
    public: false

  MyVendor\MyExtension\:
    resource: &#039;../Classes/*&#039;
    exclude: &#039;../Classes/Domain/Model/*&#039;

  MyVendor\MyExtension\UserFunction\ClassA:
    public: true</code></pre>
            <p>With this configuration, you can use dependency injection in
\MyVendor\MyExtension\UserFunction\ClassA when it is created, for example
in the context of a USER TypoScript object, which would not be
possible if this class were private.</p>
            <a id="errors-resulting-from-wrong-configuration"></a>
    </div>
            <div class="section" id="errors-resulting-from-wrong-configuration">
    <h2>Errors resulting from wrong configuration</h2>
            <p>If objects that use dependency injection are not configured properly, one or
more of the following issues may result. In such a case, check whether the
class has to be configured as public: true.</p>
            <p>ArgumentCountError is raised on missing dependency injection for
constructor-injection:</p>
            <pre><code class="language-text">(1/1) ArgumentCountError

Too few arguments to function MyVendor\MyExtension\Namespace\Class::__construct(),
0 passed in typo3/sysext/core/Classes/Utility/GeneralUtility.php on line 3461 and exactly 1 expected</code></pre>
            <p>An Error is thrown on missing dependency injection for
method-injection, once the dependency is used within the code:</p>
            <pre><code class="language-text">(1/1) Error

Call to a member function methodName() on null</code></pre>
            <a id="dependency-injection-installation-wide"></a>
    </div>
            <div class="section" id="installation-wide-configuration">
    <h2>Installation-wide configuration</h2>
            <p>One can set up a global service configuration for a project that can be used in
multiple project-specific extensions. For example, this way you can alias an
interface with a concrete implementation that can be used in several extensions.
It is also possible to register project-specific CLI commands without requiring a project-specific extension.</p>
            <p>However, this only works - due to security restrictions - if TYPO3 is configured
in a way that the project root is outside the document root, which is usually
the case in Composer-based installations.</p>
            <p>The global service configuration files services.yaml and
services.php are now read within the config/system/ path
of a TYPO3 project in Composer-based installations.</p>
            <p><strong>Example:</strong></p>
            <p>You want to use the PSR-20 clock interface as a type hint for dependency
injection in the service classes of your project&#039;s various extensions. Then the
concrete implementation may change without touching your code. In this example,
we use lcobucci/clock for the concrete implementation.</p>
            <pre><code class="language-php">use Lcobucci\Clock\SystemClock;
use Psr\Clock\ClockInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;
use Symfony\Component\DependencyInjection\Loader\Configurator\ContainerConfigurator;

return static function (
    ContainerConfigurator $containerConfigurator,
    ContainerBuilder $containerBuilder
): void {
    $services = $containerConfigurator-&gt;services();
    $services-&gt;set(ClockInterface::class)
        -&gt;factory([SystemClock::class, &#039;fromUTC&#039;]);
};</code></pre>
            <p>The concrete clock implementation is now injected when a type hint to the
interface is given:</p>
            <pre><code class="language-php">use Psr\Clock\ClockInterface;

class MyClass
{
    public function __construct(
        private readonly ClockInterface $clock
    ) {
    }

    // ...
}</code></pre>
    </div>
            <div class="section" id="dependency-injection-in-a-xclassed-class">
    <h2>Dependency injection in a XCLASSed class</h2>
            <p>When extending an existing class (for example, an Extbase controller) using
XCLASS and injecting additional dependencies using constructor
injection, ensure that a reference to the extended class is added in the
Configuration/Services.yaml file of the extending extension, as shown in
the example below:</p>
            <pre><code class="language-yaml">TYPO3\CMS\Belog\Controller\BackendLogController: &#039;@MyVendor\MyExtension\Controller\ExtendedBackendLogController&#039;</code></pre>
    </div>
            <div class="section" id="further-information">
    <h2>Further information</h2>
            

<ul>
    <li><a href="https://symfony.com/doc/current/components/dependency_injection.html">Symfony dependency injection component</a></li>
    <li><a href="https://symfony.com/doc/current/service_container.html">Symfony service container</a></li>
    <li>ext_core:Changelog/10.0/Feature-84112-SymfonyDependencyInjectionForCoreAndExtbase
of the TYPO3 Core .</li>
    <li>ext_core:Changelog/10.4/Deprecation-90803-DeprecationOfObjectManagergetInExtbaseContext</li>
    <li><a href="https://usetypo3.com/dependency-injection.html">Dependency Injection in TYPO3 - Blog Article by Daniel Goerz</a></li>
    <li><a href="https://phptherightway.com/#dependency_injection">Dependency Injection</a> in &quot;PHP The Right Way&quot;</li>
    <li><a href="http://fabien.potencier.org/what-is-dependency-injection.html">What is dependency injection?</a>
by Fabien Potencier</li>
</ul>
    </div>
    </div>

    </section>
                            </div>
            <section data-search-results class="phpdocumentor-search-results phpdocumentor-search-results--hidden">
    <section class="phpdocumentor-search-results__dialog">
        <header class="phpdocumentor-search-results__header">
            <h2 class="phpdocumentor-search-results__title">Search results</h2>
            <button class="phpdocumentor-search-results__close"><i class="fas fa-times"></i></button>
        </header>
        <section class="phpdocumentor-search-results__body">
            <ul class="phpdocumentor-search-results__entries"></ul>
        </section>
    </section>
</section>
        </div>
        <a href="guide/ApiOverview/DependencyInjection/Index.html#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <script>
        cssVars({});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/line-highlight/prism-line-highlight.min.js"></script>
</body>
</html>